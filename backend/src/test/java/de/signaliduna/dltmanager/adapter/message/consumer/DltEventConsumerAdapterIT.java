package de.signaliduna.dltmanager.adapter.message.consumer;

import tools.jackson.databind.ObjectMapper;
import de.signaliduna.dltmanager.adapter.db.DltEventRepository;
import de.signaliduna.dltmanager.adapter.db.model.DltEventEntity;
import de.signaliduna.dltmanager.test.AbstractSingletonContainerTest;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.context.TestConfiguration;
import org.springframework.cloud.function.core.FunctionInvocationHelper;
import org.springframework.cloud.stream.binder.test.InputDestination;
import org.springframework.cloud.stream.binder.test.TestChannelBinderConfiguration;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Import;
import org.springframework.data.mongodb.core.MongoOperations;
import org.springframework.data.mongodb.core.query.Query;
import org.springframework.integration.support.MessageBuilder;
import org.springframework.messaging.Message;
import tools.jackson.core.JacksonException;

import java.nio.charset.StandardCharsets;
import java.util.Base64;
import java.util.Map;

import static org.assertj.core.api.Assertions.assertThat;

@SpringBootTest(
	properties = {"com.c4-soft.springaddons.oidc.resourceserver.enabled=false"},
	webEnvironment = SpringBootTest.WebEnvironment.MOCK
)
@Import(TestChannelBinderConfiguration.class)
class DltEventConsumerAdapterIT extends AbstractSingletonContainerTest {

	@Value("${topics.elpa-dlt}")
	String elpaDltTopic;

	@Autowired
	DltEventRepository dltEventRepo;

	@Autowired
	FunctionInvocationHelper<Message<?>> functionInvocationHelper;

	@Autowired
	ObjectMapper objectMapper;

	@Autowired
	InputDestination inputDestination;

	@Autowired
	MongoOperations mongoOperations;

	@AfterEach
	void afterEach() {
		mongoOperations.remove(new Query(), DltEventEntity.class);
	}

	@Test
	void testIncomingDltEventWithInvalidPayload() {
		//origin: JSON output from `outputDestination.receive()` in partnersync ApplicationReviewAdapterIT::outputDestinationReceiveCloudEvent()
		final String cloudEventJson = """
			{
			   "payload" : "aW52YWxpZCBkYXRh",
			   "headers" : {
			     "ce_type" : "de.signaliduna.elpa.partnersync.stream.onApplicationReview-in.error",
			     "ce_source" : "/signal-iduna/elpa/partnersync",
			     "message-type" : "cloudevent",
			     "ce_specversion" : "1.0",
			     "ce_time" : "2024-07-10T11:10:36.818079+02:00",
			     "ce_id" : "e858107f-139a-46ad-b554-9b51331ddcbd",
			     "id" : "c8a4b658-e31d-4a30-6345-2a4124405bc5",
			     "contentType" : "application/json",
			     "target-protocol" : "kafka",
			     "timestamp" : 1720602636829
			   }
			 }""";

		final Message<?> messageWithKafkaStyleHeader = msgFromJsonString(cloudEventJson);
		final Message<?> message = functionInvocationHelper.preProcessInput(messageWithKafkaStyleHeader, null);
		inputDestination.send(message, elpaDltTopic);

		assertThat(dltEventRepo.streamAll()).isEmpty();
	}

	@Test
	void testIncomingDltEventWithValidPayload() {
		//origin: JSON output from `outputDestination.receive()` in partnersync ApplicationReviewAdapterIT::outputDestinationReceiveCloudEvent()
		final String cloudEventJson = """
			{
			   "payload" : "eyJvcmlnaW5hbEV2ZW50SWQiOiJjN2VlNjQ4My05ZThmLTFjNzAtMjJkMy05ODg1NTE5MTJlODMiLCJzZXJ2aWNlTmFtZSI6InBhcnRuZXJzeW5jIiwiYWRkVG9EbHRUaW1lc3RhbXAiOlsyMDI0LDcsMTAsMTEsMTAsMzYsODE4MDc5MDAwXSwidHJhY2VJZCI6ImU3NmM1ZWYyNDVlNmMyOTMzYmZhNWFmNDI1MzY1NDZhIiwicGF5bG9hZCI6IntcIm1ldGFkYXRhXCI6e1wicm9oZGF0ZW5VdWlkXCI6XCJpZFwifSxcInByb2Nlc3NJZFwiOlwiaWQxMjNcIn0iLCJwYXlsb2FkTWVkaWFUeXBlIjoiYXBwbGljYXRpb24vanNvbiIsImVycm9yIjoiZXJyb3JNZXNzYWdlIiwic3RhY2tUcmFjZSI6ImRlLnNpZ25hbGlkdW5hLnBhcnRuZXJzeW5jLmNvcmUuZXhjZXB0aW9uLkV4dGVybmFsU2VydmljZUVycm9yRXhjZXB0aW9uOiBlcnJvck1lc3NhZ2Vcblx0YXQgZGUuc2lnbmFsaWR1bmEucGFydG5lcnN5bmMuY29yZS5zZXJ2aWNlLlJldmlld1NlcnZpY2Uuc3luY1BhcnRuZXJBbmRTZW5kRXZlbnQoUmV2aWV3U2VydmljZS5qYXZhOjQ2KVxuXHRhdCBkZS5zaWduYWxpZHVuYS5wYXJ0bmVyc3luYy5hZGFwdGVyLm1lc3NhZ2UuY29uc3VtZXIuQXBwbGljYXRpb25SZXZpZXdBZGFwdGVyLm9uQXBwbGljYXRpb25SZXZpZXdJbXBsKEFwcGxpY2F0aW9uUmV2aWV3QWRhcHRlci5qYXZhOjYzKVxuXHRhdCBkZS5zaWduYWxpZHVuYS5wYXJ0bmVyc3luYy5hZGFwdGVyLm1lc3NhZ2UuY29uc3VtZXIuQXBwbGljYXRpb25SZXZpZXdBZGFwdGVyLm9uQXBwbGljYXRpb25SZXZpZXcoQXBwbGljYXRpb25SZXZpZXdBZGFwdGVyLmphdmE6NTEpXG5cdGF0IG9yZy5zcHJpbmdmcmFtZXdvcmsuY2xvdWQuZnVuY3Rpb24uY29udGV4dC5jYXRhbG9nLlNpbXBsZUZ1bmN0aW9uUmVnaXN0cnkkRnVuY3Rpb25JbnZvY2F0aW9uV3JhcHBlci5pbnZva2VDb25zdW1lcihTaW1wbGVGdW5jdGlvblJlZ2lzdHJ5LmphdmE6MTA1NSlcblx0YXQgb3JnLnNwcmluZ2ZyYW1ld29yay5jbG91ZC5mdW5jdGlvbi5jb250ZXh0LmNhdGFsb2cuU2ltcGxlRnVuY3Rpb25SZWdpc3RyeSRGdW5jdGlvbkludm9jYXRpb25XcmFwcGVyLmRvQXBwbHkoU2ltcGxlRnVuY3Rpb25SZWdpc3RyeS5qYXZhOjc1Mylcblx0YXQgb3JnLnNwcmluZ2ZyYW1ld29yay5jbG91ZC5mdW5jdGlvbi5jb250ZXh0LmNhdGFsb2cuU2ltcGxlRnVuY3Rpb25SZWdpc3RyeSRGdW5jdGlvbkludm9jYXRpb25XcmFwcGVyLmFwcGx5KFNpbXBsZUZ1bmN0aW9uUmVnaXN0cnkuamF2YTo1OTIpXG5cdGF0IG9yZy5zcHJpbmdmcmFtZXdvcmsuY2xvdWQuc3RyZWFtLmZ1bmN0aW9uLlBhcnRpdGlvbkF3YXJlRnVuY3Rpb25XcmFwcGVyLmFwcGx5KFBhcnRpdGlvbkF3YXJlRnVuY3Rpb25XcmFwcGVyLmphdmE6OTIpXG5cdGF0IG9yZy5zcHJpbmdmcmFtZXdvcmsuY2xvdWQuc3RyZWFtLmZ1bmN0aW9uLkZ1bmN0aW9uQ29uZmlndXJhdGlvbiRGdW5jdGlvbldyYXBwZXIuYXBwbHkoRnVuY3Rpb25Db25maWd1cmF0aW9uLmphdmE6ODIzKVxuXHRhdCBvcmcuc3ByaW5nZnJhbWV3b3JrLmNsb3VkLnN0cmVhbS5mdW5jdGlvbi5GdW5jdGlvbkNvbmZpZ3VyYXRpb24kRnVuY3Rpb25Ub0Rlc3RpbmF0aW9uQmluZGVyJDEuaGFuZGxlTWVzc2FnZUludGVybmFsKEZ1bmN0aW9uQ29uZmlndXJhdGlvbi5qYXZhOjY1NClcblx0YXQgb3JnLnNwcmluZ2ZyYW1ld29yay5pbnRlZ3JhdGlvbi5oYW5kbGVyLkFic3RyYWN0TWVzc2FnZUhhbmRsZXIuZG9IYW5kbGVNZXNzYWdlKEFic3RyYWN0TWVzc2FnZUhhbmRsZXIuamF2YToxMDUpXG5cdGF0IG9yZy5zcHJpbmdmcmFtZXdvcmsuaW50ZWdyYXRpb24uaGFuZGxlci5BYnN0cmFjdE1lc3NhZ2VIYW5kbGVyLmhhbmRsZU1lc3NhZ2UoQWJzdHJhY3RNZXNzYWdlSGFuZGxlci5qYXZhOjczKVxuXHRhdCBvcmcuc3ByaW5nZnJhbWV3b3JrLmludGVncmF0aW9uLmRpc3BhdGNoZXIuQWJzdHJhY3REaXNwYXRjaGVyLnRyeU9wdGltaXplZERpc3BhdGNoKEFic3RyYWN0RGlzcGF0Y2hlci5qYXZhOjEzMilcblx0YXQgb3JnLnNwcmluZ2ZyYW1ld29yay5pbnRlZ3JhdGlvbi5kaXNwYXRjaGVyLlVuaWNhc3RpbmdEaXNwYXRjaGVyLmRvRGlzcGF0Y2goVW5pY2FzdGluZ0Rpc3BhdGNoZXIuamF2YToxNDgpXG5cdGF0IG9yZy5zcHJpbmdmcmFtZXdvcmsuaW50ZWdyYXRpb24uZGlzcGF0Y2hlci5VbmljYXN0aW5nRGlzcGF0Y2hlci5kaXNwYXRjaChVbmljYXN0aW5nRGlzcGF0Y2hlci5qYXZhOjEyMSlcblx0YXQgb3JnLnNwcmluZ2ZyYW1ld29yay5pbnRlZ3JhdGlvbi5jaGFubmVsLkFic3RyYWN0U3Vic2NyaWJhYmxlQ2hhbm5lbC5kb1NlbmQoQWJzdHJhY3RTdWJzY3JpYmFibGVDaGFubmVsLmphdmE6NzIpXG5cdGF0IG9yZy5zcHJpbmdmcmFtZXdvcmsuaW50ZWdyYXRpb24uY2hhbm5lbC5BYnN0cmFjdE1lc3NhZ2VDaGFubmVsLnNlbmRJbnRlcm5hbChBYnN0cmFjdE1lc3NhZ2VDaGFubmVsLmphdmE6MzkwKVxuXHRhdCBvcmcuc3ByaW5nZnJhbWV3b3JrLmludGVncmF0aW9uLmNoYW5uZWwuQWJzdHJhY3RNZXNzYWdlQ2hhbm5lbC5zZW5kV2l0aE1ldHJpY3MoQWJzdHJhY3RNZXNzYWdlQ2hhbm5lbC5qYXZhOjM2MSlcblx0YXQgb3JnLnNwcmluZ2ZyYW1ld29yay5pbnRlZ3JhdGlvbi5jaGFubmVsLkFic3RyYWN0TWVzc2FnZUNoYW5uZWwuc2VuZChBYnN0cmFjdE1lc3NhZ2VDaGFubmVsLmphdmE6MzMxKVxuXHRhdCBvcmcuc3ByaW5nZnJhbWV3b3JrLmludGVncmF0aW9uLmNoYW5uZWwuQWJzdHJhY3RNZXNzYWdlQ2hhbm5lbC5zZW5kKEFic3RyYWN0TWVzc2FnZUNoYW5uZWwuamF2YTozMDQpXG5cdGF0IG9yZy5zcHJpbmdmcmFtZXdvcmsubWVzc2FnaW5nLmNvcmUuR2VuZXJpY01lc3NhZ2luZ1RlbXBsYXRlLmRvU2VuZChHZW5lcmljTWVzc2FnaW5nVGVtcGxhdGUuamF2YToxODcpXG5cdGF0IG9yZy5zcHJpbmdmcmFtZXdvcmsubWVzc2FnaW5nLmNvcmUuR2VuZXJpY01lc3NhZ2luZ1RlbXBsYXRlLmRvU2VuZChHZW5lcmljTWVzc2FnaW5nVGVtcGxhdGUuamF2YToxNjYpXG5cdGF0IG9yZy5zcHJpbmdmcmFtZXdvcmsubWVzc2FnaW5nLmNvcmUuR2VuZXJpY01lc3NhZ2luZ1RlbXBsYXRlLmRvU2VuZChHZW5lcmljTWVzc2FnaW5nVGVtcGxhdGUuamF2YTo0Nylcblx0YXQgb3JnLnNwcmluZ2ZyYW1ld29yay5tZXNzYWdpbmcuY29yZS5BYnN0cmFjdE1lc3NhZ2VTZW5kaW5nVGVtcGxhdGUuc2VuZChBYnN0cmFjdE1lc3NhZ2VTZW5kaW5nVGVtcGxhdGUuamF2YToxMDkpXG5cdGF0IG9yZy5zcHJpbmdmcmFtZXdvcmsuaW50ZWdyYXRpb24uZW5kcG9pbnQuTWVzc2FnZVByb2R1Y2VyU3VwcG9ydC5sYW1iZGEkc2VuZE1lc3NhZ2UkMShNZXNzYWdlUHJvZHVjZXJTdXBwb3J0LmphdmE6MjYyKVxuXHRhdCBpby5taWNyb21ldGVyLm9ic2VydmF0aW9uLk9ic2VydmF0aW9uLm9ic2VydmUoT2JzZXJ2YXRpb24uamF2YTo0OTkpXG5cdGF0IG9yZy5zcHJpbmdmcmFtZXdvcmsuaW50ZWdyYXRpb24uZW5kcG9pbnQuTWVzc2FnZVByb2R1Y2VyU3VwcG9ydC5zZW5kTWVzc2FnZShNZXNzYWdlUHJvZHVjZXJTdXBwb3J0LmphdmE6MjYyKVxuXHRhdCBvcmcuc3ByaW5nZnJhbWV3b3JrLmNsb3VkLnN0cmVhbS5iaW5kZXIudGVzdC5UZXN0Q2hhbm5lbEJpbmRlciRJbnRlZ3JhdGlvbkJpbmRlckluYm91bmRDaGFubmVsQWRhcHRlci5hY2Nlc3MkMjAwKFRlc3RDaGFubmVsQmluZGVyLmphdmE6MjIwKVxuXHRhdCBvcmcuc3ByaW5nZnJhbWV3b3JrLmNsb3VkLnN0cmVhbS5iaW5kZXIudGVzdC5UZXN0Q2hhbm5lbEJpbmRlciRJbnRlZ3JhdGlvbkJpbmRlckluYm91bmRDaGFubmVsQWRhcHRlciRMaXN0ZW5lci5wcm9jZXNzTWVzc2FnZShUZXN0Q2hhbm5lbEJpbmRlci5qYXZhOjI5OClcblx0YXQgb3JnLnNwcmluZ2ZyYW1ld29yay5jbG91ZC5zdHJlYW0uYmluZGVyLnRlc3QuVGVzdENoYW5uZWxCaW5kZXIkSW50ZWdyYXRpb25CaW5kZXJJbmJvdW5kQ2hhbm5lbEFkYXB0ZXIkTGlzdGVuZXIubGFtYmRhJGFjY2VwdCQwKFRlc3RDaGFubmVsQmluZGVyLmphdmE6Mjc4KVxuXHRhdCBvcmcuc3ByaW5nZnJhbWV3b3JrLnJldHJ5LnN1cHBvcnQuUmV0cnlUZW1wbGF0ZS5kb0V4ZWN1dGUoUmV0cnlUZW1wbGF0ZS5qYXZhOjM0NClcblx0YXQgb3JnLnNwcmluZ2ZyYW1ld29yay5yZXRyeS5zdXBwb3J0LlJldHJ5VGVtcGxhdGUuZXhlY3V0ZShSZXRyeVRlbXBsYXRlLmphdmE6MjMzKVxuXHRhdCBvcmcuc3ByaW5nZnJhbWV3b3JrLmNsb3VkLnN0cmVhbS5iaW5kZXIudGVzdC5UZXN0Q2hhbm5lbEJpbmRlciRJbnRlZ3JhdGlvbkJpbmRlckluYm91bmRDaGFubmVsQWRhcHRlciRMaXN0ZW5lci5hY2NlcHQoVGVzdENoYW5uZWxCaW5kZXIuamF2YToyNzcpXG5cdGF0IG9yZy5zcHJpbmdmcmFtZXdvcmsuY2xvdWQuc3RyZWFtLmJpbmRlci50ZXN0LlRlc3RDaGFubmVsQmluZGVyJEludGVncmF0aW9uQmluZGVySW5ib3VuZENoYW5uZWxBZGFwdGVyJExpc3RlbmVyLmFjY2VwdChUZXN0Q2hhbm5lbEJpbmRlci5qYXZhOjI2MSlcblx0YXQgb3JnLnNwcmluZ2ZyYW1ld29yay5jbG91ZC5zdHJlYW0uYmluZGVyLnRlc3QuVGVzdENoYW5uZWxCaW5kZXIkSW50ZWdyYXRpb25NZXNzYWdlTGlzdGVuaW5nQ29udGFpbmVyLmhhbmRsZU1lc3NhZ2UoVGVzdENoYW5uZWxCaW5kZXIuamF2YToyMDgpXG5cdGF0IG9yZy5zcHJpbmdmcmFtZXdvcmsuaW50ZWdyYXRpb24uZGlzcGF0Y2hlci5Ccm9hZGNhc3RpbmdEaXNwYXRjaGVyLmludm9rZUhhbmRsZXIoQnJvYWRjYXN0aW5nRGlzcGF0Y2hlci5qYXZhOjIzNSlcblx0YXQgb3JnLnNwcmluZ2ZyYW1ld29yay5pbnRlZ3JhdGlvbi5kaXNwYXRjaGVyLkJyb2FkY2FzdGluZ0Rpc3BhdGNoZXIuZGlzcGF0Y2goQnJvYWRjYXN0aW5nRGlzcGF0Y2hlci5qYXZhOjE5Milcblx0YXQgb3JnLnNwcmluZ2ZyYW1ld29yay5pbnRlZ3JhdGlvbi5jaGFubmVsLkFic3RyYWN0U3Vic2NyaWJhYmxlQ2hhbm5lbC5kb1NlbmQoQWJzdHJhY3RTdWJzY3JpYmFibGVDaGFubmVsLmphdmE6NzIpXG5cdGF0IG9yZy5zcHJpbmdmcmFtZXdvcmsuaW50ZWdyYXRpb24uY2hhbm5lbC5BYnN0cmFjdE1lc3NhZ2VDaGFubmVsLnNlbmRJbnRlcm5hbChBYnN0cmFjdE1lc3NhZ2VDaGFubmVsLmphdmE6MzkwKVxuXHRhdCBvcmcuc3ByaW5nZnJhbWV3b3JrLmludGVncmF0aW9uLmNoYW5uZWwuQWJzdHJhY3RNZXNzYWdlQ2hhbm5lbC5zZW5kKEFic3RyYWN0TWVzc2FnZUNoYW5uZWwuamF2YTozMzQpXG5cdGF0IG9yZy5zcHJpbmdmcmFtZXdvcmsuaW50ZWdyYXRpb24uY2hhbm5lbC5BYnN0cmFjdE1lc3NhZ2VDaGFubmVsLnNlbmQoQWJzdHJhY3RNZXNzYWdlQ2hhbm5lbC5qYXZhOjMwNClcblx0YXQgb3JnLnNwcmluZ2ZyYW1ld29yay5jbG91ZC5zdHJlYW0uYmluZGVyLnRlc3QuSW5wdXREZXN0aW5hdGlvbi5zZW5kKElucHV0RGVzdGluYXRpb24uamF2YTo4OSlcblx0YXQgZGUuc2lnbmFsaWR1bmEucGFydG5lcnN5bmMuYWRhcHRlci5tZXNzYWdlLmNvbnN1bWVyLkFwcGxpY2F0aW9uUmV2aWV3QWRhcHRlcklULmV4dGVybmFsU2VydmljZUVycm9yRXhjZXB0aW9uV2l0aFN0YXR1c0JhZFJlcXVlc3RPY2N1cnMoQXBwbGljYXRpb25SZXZpZXdBZGFwdGVySVQuamF2YToxNTcpXG5cdGF0IGphdmEuYmFzZS9qZGsuaW50ZXJuYWwucmVmbGVjdC5EaXJlY3RNZXRob2RIYW5kbGVBY2Nlc3Nvci5pbnZva2UoRGlyZWN0TWV0aG9kSGFuZGxlQWNjZXNzb3IuamF2YToxMDMpXG5cdGF0IGphdmEuYmFzZS9qYXZhLmxhbmcucmVmbGVjdC5NZXRob2QuaW52b2tlKE1ldGhvZC5qYXZhOjU4MClcblx0YXQgb3JnLmp1bml0LnBsYXRmb3JtLmNvbW1vbnMudXRpbC5SZWZsZWN0aW9uVXRpbHMuaW52b2tlTWV0aG9kKFJlZmxlY3Rpb25VdGlscy5qYXZhOjcyOClcblx0YXQgb3JnLmp1bml0Lmp1cGl0ZXIuZW5naW5lLmV4ZWN1dGlvbi5NZXRob2RJbnZvY2F0aW9uLnByb2NlZWQoTWV0aG9kSW52b2NhdGlvbi5qYXZhOjYwKVxuXHRhdCBvcmcuanVuaXQuanVwaXRlci5lbmdpbmUuZXhlY3V0aW9uLkludm9jYXRpb25JbnRlcmNlcHRvckNoYWluJFZhbGlkYXRpbmdJbnZvY2F0aW9uLnByb2NlZWQoSW52b2NhdGlvbkludGVyY2VwdG9yQ2hhaW4uamF2YToxMzEpXG5cdGF0IG9yZy5qdW5pdC5qdXBpdGVyLmVuZ2luZS5leHRlbnNpb24uVGltZW91dEV4dGVuc2lvbi5pbnRlcmNlcHQoVGltZW91dEV4dGVuc2lvbi5qYXZhOjE1Nilcblx0YXQgb3JnLmp1bml0Lmp1cGl0ZXIuZW5naW5lLmV4dGVuc2lvbi5UaW1lb3V0RXh0ZW5zaW9uLmludGVyY2VwdFRlc3RhYmxlTWV0aG9kKFRpbWVvdXRFeHRlbnNpb24uamF2YToxNDcpXG5cdGF0IG9yZy5qdW5pdC5qdXBpdGVyLmVuZ2luZS5leHRlbnNpb24uVGltZW91dEV4dGVuc2lvbi5pbnRlcmNlcHRUZXN0TWV0aG9kKFRpbWVvdXRFeHRlbnNpb24uamF2YTo4Nilcblx0YXQgb3JnLmp1bml0Lmp1cGl0ZXIuZW5naW5lLmV4ZWN1dGlvbi5JbnRlcmNlcHRpbmdFeGVjdXRhYmxlSW52b2tlciRSZWZsZWN0aXZlSW50ZXJjZXB0b3JDYWxsLmxhbWJkYSRvZlZvaWRNZXRob2QkMChJbnRlcmNlcHRpbmdFeGVjdXRhYmxlSW52b2tlci5qYXZhOjEwMylcblx0YXQgb3JnLmp1bml0Lmp1cGl0ZXIuZW5naW5lLmV4ZWN1dGlvbi5JbnRlcmNlcHRpbmdFeGVjdXRhYmxlSW52b2tlci5sYW1iZGEkaW52b2tlJDAoSW50ZXJjZXB0aW5nRXhlY3V0YWJsZUludm9rZXIuamF2YTo5Mylcblx0YXQgb3JnLmp1bml0Lmp1cGl0ZXIuZW5naW5lLmV4ZWN1dGlvbi5JbnZvY2F0aW9uSW50ZXJjZXB0b3JDaGFpbiRJbnRlcmNlcHRlZEludm9jYXRpb24ucHJvY2VlZChJbnZvY2F0aW9uSW50ZXJjZXB0b3JDaGFpbi5qYXZhOjEwNilcblx0YXQgb3JnLmp1bml0Lmp1cGl0ZXIuZW5naW5lLmV4ZWN1dGlvbi5JbnZvY2F0aW9uSW50ZXJjZXB0b3JDaGFpbi5wcm9jZWVkKEludm9jYXRpb25JbnRlcmNlcHRvckNoYWluLmphdmE6NjQpXG5cdGF0IG9yZy5qdW5pdC5qdXBpdGVyLmVuZ2luZS5leGVjdXRpb24uSW52b2NhdGlvbkludGVyY2VwdG9yQ2hhaW4uY2hhaW5BbmRJbnZva2UoSW52b2NhdGlvbkludGVyY2VwdG9yQ2hhaW4uamF2YTo0NSlcblx0YXQgb3JnLmp1bml0Lmp1cGl0ZXIuZW5naW5lLmV4ZWN1dGlvbi5JbnZvY2F0aW9uSW50ZXJjZXB0b3JDaGFpbi5pbnZva2UoSW52b2NhdGlvbkludGVyY2VwdG9yQ2hhaW4uamF2YTozNylcblx0YXQgb3JnLmp1bml0Lmp1cGl0ZXIuZW5naW5lLmV4ZWN1dGlvbi5JbnRlcmNlcHRpbmdFeGVjdXRhYmxlSW52b2tlci5pbnZva2UoSW50ZXJjZXB0aW5nRXhlY3V0YWJsZUludm9rZXIuamF2YTo5Milcblx0YXQgb3JnLmp1bml0Lmp1cGl0ZXIuZW5naW5lLmV4ZWN1dGlvbi5JbnRlcmNlcHRpbmdFeGVjdXRhYmxlSW52b2tlci5pbnZva2UoSW50ZXJjZXB0aW5nRXhlY3V0YWJsZUludm9rZXIuamF2YTo4Nilcblx0YXQgb3JnLmp1bml0Lmp1cGl0ZXIuZW5naW5lLmRlc2NyaXB0b3IuVGVzdE1ldGhvZFRlc3REZXNjcmlwdG9yLmxhbWJkYSRpbnZva2VUZXN0TWV0aG9kJDcoVGVzdE1ldGhvZFRlc3REZXNjcmlwdG9yLmphdmE6MjE4KVxuXHRhdCBvcmcuanVuaXQucGxhdGZvcm0uZW5naW5lLnN1cHBvcnQuaGllcmFyY2hpY2FsLlRocm93YWJsZUNvbGxlY3Rvci5leGVjdXRlKFRocm93YWJsZUNvbGxlY3Rvci5qYXZhOjczKVxuXHRhdCBvcmcuanVuaXQuanVwaXRlci5lbmdpbmUuZGVzY3JpcHRvci5UZXN0TWV0aG9kVGVzdERlc2NyaXB0b3IuaW52b2tlVGVzdE1ldGhvZChUZXN0TWV0aG9kVGVzdERlc2NyaXB0b3IuamF2YToyMTQpXG5cdGF0IG9yZy5qdW5pdC5qdXBpdGVyLmVuZ2luZS5kZXNjcmlwdG9yLlRlc3RNZXRob2RUZXN0RGVzY3JpcHRvci5leGVjdXRlKFRlc3RNZXRob2RUZXN0RGVzY3JpcHRvci5qYXZhOjEzOSlcblx0YXQgb3JnLmp1bml0Lmp1cGl0ZXIuZW5naW5lLmRlc2NyaXB0b3IuVGVzdE1ldGhvZFRlc3REZXNjcmlwdG9yLmV4ZWN1dGUoVGVzdE1ldGhvZFRlc3REZXNjcmlwdG9yLmphdmE6NjkpXG5cdGF0IG9yZy5qdW5pdC5wbGF0Zm9ybS5lbmdpbmUuc3VwcG9ydC5oaWVyYXJjaGljYWwuTm9kZVRlc3RUYXNrLmxhbWJkYSRleGVjdXRlUmVjdXJzaXZlbHkkNihOb2RlVGVzdFRhc2suamF2YToxNTEpXG5cdGF0IG9yZy5qdW5pdC5wbGF0Zm9ybS5lbmdpbmUuc3VwcG9ydC5oaWVyYXJjaGljYWwuVGhyb3dhYmxlQ29sbGVjdG9yLmV4ZWN1dGUoVGhyb3dhYmxlQ29sbGVjdG9yLmphdmE6NzMpXG5cdGF0IG9yZy5qdW5pdC5wbGF0Zm9ybS5lbmdpbmUuc3VwcG9ydC5oaWVyYXJjaGljYWwuTm9kZVRlc3RUYXNrLmxhbWJkYSRleGVjdXRlUmVjdXJzaXZlbHkkOChOb2RlVGVzdFRhc2suamF2YToxNDEpXG5cdGF0IG9yZy5qdW5pdC5wbGF0Zm9ybS5lbmdpbmUuc3VwcG9ydC5oaWVyYXJjaGljYWwuTm9kZS5hcm91bmQoTm9kZS5qYXZhOjEzNylcblx0YXQgb3JnLmp1bml0LnBsYXRmb3JtLmVuZ2luZS5zdXBwb3J0LmhpZXJhcmNoaWNhbC5Ob2RlVGVzdFRhc2subGFtYmRhJGV4ZWN1dGVSZWN1cnNpdmVseSQ5KE5vZGVUZXN0VGFzay5qYXZhOjEzOSlcblx0YXQgb3JnLmp1bml0LnBsYXRmb3JtLmVuZ2luZS5zdXBwb3J0LmhpZXJhcmNoaWNhbC5UaHJvd2FibGVDb2xsZWN0b3IuZXhlY3V0ZShUaHJvd2FibGVDb2xsZWN0b3IuamF2YTo3Mylcblx0YXQgb3JnLmp1bml0LnBsYXRmb3JtLmVuZ2luZS5zdXBwb3J0LmhpZXJhcmNoaWNhbC5Ob2RlVGVzdFRhc2suZXhlY3V0ZVJlY3Vyc2l2ZWx5KE5vZGVUZXN0VGFzay5qYXZhOjEzOClcblx0YXQgb3JnLmp1bml0LnBsYXRmb3JtLmVuZ2luZS5zdXBwb3J0LmhpZXJhcmNoaWNhbC5Ob2RlVGVzdFRhc2suZXhlY3V0ZShOb2RlVGVzdFRhc2suamF2YTo5NSlcblx0YXQgamF2YS5iYXNlL2phdmEudXRpbC5BcnJheUxpc3QuZm9yRWFjaChBcnJheUxpc3QuamF2YToxNTk2KVxuXHRhdCBvcmcuanVuaXQucGxhdGZvcm0uZW5naW5lLnN1cHBvcnQuaGllcmFyY2hpY2FsLlNhbWVUaHJlYWRIaWVyYXJjaGljYWxUZXN0RXhlY3V0b3JTZXJ2aWNlLmludm9rZUFsbChTYW1lVGhyZWFkSGllcmFyY2hpY2FsVGVzdEV4ZWN1dG9yU2VydmljZS5qYXZhOjQxKVxuXHRhdCBvcmcuanVuaXQucGxhdGZvcm0uZW5naW5lLnN1cHBvcnQuaGllcmFyY2hpY2FsLk5vZGVUZXN0VGFzay5sYW1iZGEkZXhlY3V0ZVJlY3Vyc2l2ZWx5JDYoTm9kZVRlc3RUYXNrLmphdmE6MTU1KVxuXHRhdCBvcmcuanVuaXQucGxhdGZvcm0uZW5naW5lLnN1cHBvcnQuaGllcmFyY2hpY2FsLlRocm93YWJsZUNvbGxlY3Rvci5leGVjdXRlKFRocm93YWJsZUNvbGxlY3Rvci5qYXZhOjczKVxuXHRhdCBvcmcuanVuaXQucGxhdGZvcm0uZW5naW5lLnN1cHBvcnQuaGllcmFyY2hpY2FsLk5vZGVUZXN0VGFzay5sYW1iZGEkZXhlY3V0ZVJlY3Vyc2l2ZWx5JDgoTm9kZVRlc3RUYXNrLmphdmE6MTQxKVxuXHRhdCBvcmcuanVuaXQucGxhdGZvcm0uZW5naW5lLnN1cHBvcnQuaGllcmFyY2hpY2FsLk5vZGUuYXJvdW5kKE5vZGUuamF2YToxMzcpXG5cdGF0IG9yZy5qdW5pdC5wbGF0Zm9ybS5lbmdpbmUuc3VwcG9ydC5oaWVyYXJjaGljYWwuTm9kZVRlc3RUYXNrLmxhbWJkYSRleGVjdXRlUmVjdXJzaXZlbHkkOShOb2RlVGVzdFRhc2suamF2YToxMzkpXG5cdGF0IG9yZy5qdW5pdC5wbGF0Zm9ybS5lbmdpbmUuc3VwcG9ydC5oaWVyYXJjaGljYWwuVGhyb3dhYmxlQ29sbGVjdG9yLmV4ZWN1dGUoVGhyb3dhYmxlQ29sbGVjdG9yLmphdmE6NzMpXG5cdGF0IG9yZy5qdW5pdC5wbGF0Zm9ybS5lbmdpbmUuc3VwcG9ydC5oaWVyYXJjaGljYWwuTm9kZVRlc3RUYXNrLmV4ZWN1dGVSZWN1cnNpdmVseShOb2RlVGVzdFRhc2suamF2YToxMzgpXG5cdGF0IG9yZy5qdW5pdC5wbGF0Zm9ybS5lbmdpbmUuc3VwcG9ydC5oaWVyYXJjaGljYWwuTm9kZVRlc3RUYXNrLmV4ZWN1dGUoTm9kZVRlc3RUYXNrLmphdmE6OTUpXG5cdGF0IGphdmEuYmFzZS9qYXZhLnV0aWwuQXJyYXlMaXN0LmZvckVhY2goQXJyYXlMaXN0LmphdmE6MTU5Nilcblx0YXQgb3JnLmp1bml0LnBsYXRmb3JtLmVuZ2luZS5zdXBwb3J0LmhpZXJhcmNoaWNhbC5TYW1lVGhyZWFkSGllcmFyY2hpY2FsVGVzdEV4ZWN1dG9yU2VydmljZS5pbnZva2VBbGwoU2FtZVRocmVhZEhpZXJhcmNoaWNhbFRlc3RFeGVjdXRvclNlcnZpY2UuamF2YTo0MSlcblx0YXQgb3JnLmp1bml0LnBsYXRmb3JtLmVuZ2luZS5zdXBwb3J0LmhpZXJhcmNoaWNhbC5Ob2RlVGVzdFRhc2subGFtYmRhJGV4ZWN1dGVSZWN1cnNpdmVseSQ2KE5vZGVUZXN0VGFzay5qYXZhOjE1NSlcblx0YXQgb3JnLmp1bml0LnBsYXRmb3JtLmVuZ2luZS5zdXBwb3J0LmhpZXJhcmNoaWNhbC5UaHJvd2FibGVDb2xsZWN0b3IuZXhlY3V0ZShUaHJvd2FibGVDb2xsZWN0b3IuamF2YTo3Mylcblx0YXQgb3JnLmp1bml0LnBsYXRmb3JtLmVuZ2luZS5zdXBwb3J0LmhpZXJhcmNoaWNhbC5Ob2RlVGVzdFRhc2subGFtYmRhJGV4ZWN1dGVSZWN1cnNpdmVseSQ4KE5vZGVUZXN0VGFzay5qYXZhOjE0MSlcblx0YXQgb3JnLmp1bml0LnBsYXRmb3JtLmVuZ2luZS5zdXBwb3J0LmhpZXJhcmNoaWNhbC5Ob2RlLmFyb3VuZChOb2RlLmphdmE6MTM3KVxuXHRhdCBvcmcuanVuaXQucGxhdGZvcm0uZW5naW5lLnN1cHBvcnQuaGllcmFyY2hpY2FsLk5vZGVUZXN0VGFzay5sYW1iZGEkZXhlY3V0ZVJlY3Vyc2l2ZWx5JDkoTm9kZVRlc3RUYXNrLmphdmE6MTM5KVxuXHRhdCBvcmcuanVuaXQucGxhdGZvcm0uZW5naW5lLnN1cHBvcnQuaGllcmFyY2hpY2FsLlRocm93YWJsZUNvbGxlY3Rvci5leGVjdXRlKFRocm93YWJsZUNvbGxlY3Rvci5qYXZhOjczKVxuXHRhdCBvcmcuanVuaXQucGxhdGZvcm0uZW5naW5lLnN1cHBvcnQuaGllcmFyY2hpY2FsLk5vZGVUZXN0VGFzay5leGVjdXRlUmVjdXJzaXZlbHkoTm9kZVRlc3RUYXNrLmphdmE6MTM4KVxuXHRhdCBvcmcuanVuaXQucGxhdGZvcm0uZW5naW5lLnN1cHBvcnQuaGllcmFyY2hpY2FsLk5vZGVUZXN0VGFzay5leGVjdXRlKE5vZGVUZXN0VGFzay5qYXZhOjk1KVxuXHRhdCBvcmcuanVuaXQucGxhdGZvcm0uZW5naW5lLnN1cHBvcnQuaGllcmFyY2hpY2FsLlNhbWVUaHJlYWRIaWVyYXJjaGljYWxUZXN0RXhlY3V0b3JTZXJ2aWNlLnN1Ym1pdChTYW1lVGhyZWFkSGllcmFyY2hpY2FsVGVzdEV4ZWN1dG9yU2VydmljZS5qYXZhOjM1KVxuXHRhdCBvcmcuanVuaXQucGxhdGZvcm0uZW5naW5lLnN1cHBvcnQuaGllcmFyY2hpY2FsLkhpZXJhcmNoaWNhbFRlc3RFeGVjdXRvci5leGVjdXRlKEhpZXJhcmNoaWNhbFRlc3RFeGVjdXRvci5qYXZhOjU3KVxuXHRhdCBvcmcuanVuaXQucGxhdGZvcm0uZW5naW5lLnN1cHBvcnQuaGllcmFyY2hpY2FsLkhpZXJhcmNoaWNhbFRlc3RFbmdpbmUuZXhlY3V0ZShIaWVyYXJjaGljYWxUZXN0RW5naW5lLmphdmE6NTQpXG5cdGF0IG9yZy5qdW5pdC5wbGF0Zm9ybS5sYXVuY2hlci5jb3JlLkVuZ2luZUV4ZWN1dGlvbk9yY2hlc3RyYXRvci5leGVjdXRlKEVuZ2luZUV4ZWN1dGlvbk9yY2hlc3RyYXRvci5qYXZhOjE5OClcblx0YXQgb3JnLmp1bml0LnBsYXRmb3JtLmxhdW5jaGVyLmNvcmUuRW5naW5lRXhlY3V0aW9uT3JjaGVzdHJhdG9yLmV4ZWN1dGUoRW5naW5lRXhlY3V0aW9uT3JjaGVzdHJhdG9yLmphdmE6MTY5KVxuXHRhdCBvcmcuanVuaXQucGxhdGZvcm0ubGF1bmNoZXIuY29yZS5FbmdpbmVFeGVjdXRpb25PcmNoZXN0cmF0b3IuZXhlY3V0ZShFbmdpbmVFeGVjdXRpb25PcmNoZXN0cmF0b3IuamF2YTo5Mylcblx0YXQgb3JnLmp1bml0LnBsYXRmb3JtLmxhdW5jaGVyLmNvcmUuRW5naW5lRXhlY3V0aW9uT3JjaGVzdHJhdG9yLmxhbWJkYSRleGVjdXRlJDAoRW5naW5lRXhlY3V0aW9uT3JjaGVzdHJhdG9yLmphdmE6NTgpXG5cdGF0IG9yZy5qdW5pdC5wbGF0Zm9ybS5sYXVuY2hlci5jb3JlLkVuZ2luZUV4ZWN1dGlvbk9yY2hlc3RyYXRvci53aXRoSW50ZXJjZXB0ZWRTdHJlYW1zKEVuZ2luZUV4ZWN1dGlvbk9yY2hlc3RyYXRvci5qYXZhOjE0MSlcblx0YXQgb3JnLmp1bml0LnBsYXRmb3JtLmxhdW5jaGVyLmNvcmUuRW5naW5lRXhlY3V0aW9uT3JjaGVzdHJhdG9yLmV4ZWN1dGUoRW5naW5lRXhlY3V0aW9uT3JjaGVzdHJhdG9yLmphdmE6NTcpXG5cdGF0IG9yZy5qdW5pdC5wbGF0Zm9ybS5sYXVuY2hlci5jb3JlLkRlZmF1bHRMYXVuY2hlci5leGVjdXRlKERlZmF1bHRMYXVuY2hlci5qYXZhOjEwMylcblx0YXQgb3JnLmp1bml0LnBsYXRmb3JtLmxhdW5jaGVyLmNvcmUuRGVmYXVsdExhdW5jaGVyLmV4ZWN1dGUoRGVmYXVsdExhdW5jaGVyLmphdmE6ODUpXG5cdGF0IG9yZy5qdW5pdC5wbGF0Zm9ybS5sYXVuY2hlci5jb3JlLkRlbGVnYXRpbmdMYXVuY2hlci5leGVjdXRlKERlbGVnYXRpbmdMYXVuY2hlci5qYXZhOjQ3KVxuXHRhdCBvcmcuanVuaXQucGxhdGZvcm0ubGF1bmNoZXIuY29yZS5TZXNzaW9uUGVyUmVxdWVzdExhdW5jaGVyLmV4ZWN1dGUoU2Vzc2lvblBlclJlcXVlc3RMYXVuY2hlci5qYXZhOjYzKVxuXHRhdCBjb20uaW50ZWxsaWouanVuaXQ1LkpVbml0NUlkZWFUZXN0UnVubmVyLnN0YXJ0UnVubmVyV2l0aEFyZ3MoSlVuaXQ1SWRlYVRlc3RSdW5uZXIuamF2YTo1Nylcblx0YXQgY29tLmludGVsbGlqLnJ0Lmp1bml0LklkZWFUZXN0UnVubmVyJFJlcGVhdGVyJDEuZXhlY3V0ZShJZGVhVGVzdFJ1bm5lci5qYXZhOjM4KVxuXHRhdCBjb20uaW50ZWxsaWoucnQuZXhlY3V0aW9uLmp1bml0LlRlc3RzUmVwZWF0ZXIucmVwZWF0KFRlc3RzUmVwZWF0ZXIuamF2YToxMSlcblx0YXQgY29tLmludGVsbGlqLnJ0Lmp1bml0LklkZWFUZXN0UnVubmVyJFJlcGVhdGVyLnN0YXJ0UnVubmVyV2l0aEFyZ3MoSWRlYVRlc3RSdW5uZXIuamF2YTozNSlcblx0YXQgY29tLmludGVsbGlqLnJ0Lmp1bml0LkpVbml0U3RhcnRlci5wcmVwYXJlU3RyZWFtc0FuZFN0YXJ0KEpVbml0U3RhcnRlci5qYXZhOjIzMilcblx0YXQgY29tLmludGVsbGlqLnJ0Lmp1bml0LkpVbml0U3RhcnRlci5tYWluKEpVbml0U3RhcnRlci5qYXZhOjU1KVxuIn0=",
			   "headers" : {
			     "ce_type" : "de.signaliduna.elpa.partnersync.stream.onApplicationReview-in.error",
			     "ce_source" : "/signal-iduna/elpa/partnersync",
			     "message-type" : "cloudevent",
			     "ce_specversion" : "1.0",
			     "ce_time" : "2024-07-10T11:10:36.818079+02:00",
			     "ce_id" : "e858107f-139a-46ad-b554-9b51331ddcbd",
			     "id" : "c8a4b658-e31d-4a30-6345-2a4124405bc5",
			     "contentType" : "application/json",
			     "target-protocol" : "kafka",
			     "timestamp" : 1720602636829
			   }
			 }""";

		final Message<?> messageWithKafkaStyleHeader = msgFromJsonString(cloudEventJson);
		final Message<?> message = functionInvocationHelper.preProcessInput(messageWithKafkaStyleHeader, null);
		inputDestination.send(message, elpaDltTopic);

		assertThat(dltEventRepo.streamAll()).hasSize(1);
	}

	private Message<?> msgFromJsonString(String jsonString) {
		try {
			final var messageDto = objectMapper.readValue(jsonString, MessageDto.class);
			final var decodedPayload = Base64.getDecoder().decode(messageDto.payload);
			final var decodedPayloadStr = new String(decodedPayload, StandardCharsets.UTF_8);
			return MessageBuilder.withPayload(decodedPayloadStr).copyHeaders(messageDto.headers).build();
		} catch (JacksonException e) {
			throw new RuntimeException(e);
		}
	}

	private record MessageDto(String payload, Map<String, String> headers) {
	}

	@TestConfiguration
	static class AdapterTestConfiguration {
		@Bean
		public ObjectMapper dltEventPersistenceService() {
			final var om = new ObjectMapper();
			return om;
		}
	}
}
